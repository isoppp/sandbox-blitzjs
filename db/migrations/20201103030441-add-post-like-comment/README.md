# Migration `20201103030441-add-post-like-comment`

This migration has been generated by isoppp at 11/3/2020, 12:04:41 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "public"."UserRole" AS ENUM ('USER_ROLE_ADMIN', 'USER_ROLE_USER')

CREATE TYPE "public"."PostStatus" AS ENUM ('POST_STATUS_DRAFT', 'POST_STATUS_PUBLISHED', 'POST_STATUS_UNPUBLISHED')

CREATE TABLE "public"."User" (
"id" SERIAL,
"createdAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedAt" timestamp(3)   NOT NULL ,
"displayId" text   NOT NULL ,
"name" text   ,
"email" text   NOT NULL ,
"hashedPassword" text   ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."Session" (
"id" SERIAL,
"createdAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedAt" timestamp(3)   NOT NULL ,
"expiresAt" timestamp(3)   ,
"handle" text   NOT NULL ,
"userId" integer   ,
"hashedSessionToken" text   ,
"antiCSRFToken" text   ,
"publicData" text   ,
"privateData" text   ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."Role" (
"id" SERIAL,
"name" "UserRole"  NOT NULL ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."Project" (
"id" SERIAL,
"createdAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedAt" timestamp(3)   NOT NULL ,
"name" text   NOT NULL ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."Post" (
"id" SERIAL,
"createdAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedAt" timestamp(3)   NOT NULL ,
"slug" text   NOT NULL ,
"title" text   NOT NULL ,
"content" text   NOT NULL ,
"status" "PostStatus"  NOT NULL DEFAULT E'POST_STATUS_DRAFT',
"authorId" integer   NOT NULL ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."LikePost" (
"id" SERIAL,
"createdAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"postId" integer   NOT NULL ,
"userId" integer   NOT NULL ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."PostComment" (
"id" SERIAL,
"createdAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedAt" timestamp(3)   NOT NULL ,
"content" text   NOT NULL ,
"postId" integer   NOT NULL ,
"userId" integer   NOT NULL ,
"parentId" integer   ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."_RoleToUser" (
"A" integer   NOT NULL ,
"B" integer   NOT NULL 
)

CREATE UNIQUE INDEX "User.displayId_unique" ON "public"."User"("displayId")

CREATE UNIQUE INDEX "User.email_unique" ON "public"."User"("email")

CREATE UNIQUE INDEX "Session.handle_unique" ON "public"."Session"("handle")

CREATE UNIQUE INDEX "Role.name_unique" ON "public"."Role"("name")

CREATE UNIQUE INDEX "Post.slug_unique" ON "public"."Post"("slug")

CREATE INDEX "Post.status_index" ON "public"."Post"("status")

CREATE UNIQUE INDEX "LikePost.postId_userId_unique" ON "public"."LikePost"("postId", "userId")

CREATE UNIQUE INDEX "_RoleToUser_AB_unique" ON "public"."_RoleToUser"("A", "B")

CREATE INDEX "_RoleToUser_B_index" ON "public"."_RoleToUser"("B")

ALTER TABLE "public"."Session" ADD FOREIGN KEY("userId")REFERENCES "public"."User"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."Post" ADD FOREIGN KEY("authorId")REFERENCES "public"."User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."LikePost" ADD FOREIGN KEY("postId")REFERENCES "public"."Post"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."LikePost" ADD FOREIGN KEY("userId")REFERENCES "public"."User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."PostComment" ADD FOREIGN KEY("postId")REFERENCES "public"."Post"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."PostComment" ADD FOREIGN KEY("userId")REFERENCES "public"."User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."PostComment" ADD FOREIGN KEY("parentId")REFERENCES "public"."PostComment"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."_RoleToUser" ADD FOREIGN KEY("A")REFERENCES "public"."Role"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."_RoleToUser" ADD FOREIGN KEY("B")REFERENCES "public"."User"("id") ON DELETE CASCADE ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20201102141639-change-role-strategy..20201103030441-add-post-like-comment
--- datamodel.dml
+++ datamodel.dml
@@ -2,27 +2,43 @@
 // learn more about it in the docs: https://pris.ly/d/prisma-schema
 datasource db {
   provider = "postgres"
-  url = "***"
+  url = "***"
 }
 generator client {
   provider = "prisma-client-js"
 }
 // --------------------------------------
+enum UserRole {
+  USER_ROLE_ADMIN
+  USER_ROLE_USER
+}
+
+enum PostStatus {
+  POST_STATUS_DRAFT
+  POST_STATUS_PUBLISHED
+  POST_STATUS_UNPUBLISHED
+}
+
+// --------------------------------------
+
 model User {
-  id             Int       @default(autoincrement()) @id
-  createdAt      DateTime  @default(now())
-  updatedAt      DateTime  @updatedAt
-  displayId      String    @default(cuid()) @unique
+  id             Int           @default(autoincrement()) @id
+  createdAt      DateTime      @default(now())
+  updatedAt      DateTime      @updatedAt
+  displayId      String        @default(cuid()) @unique
   name           String?
-  email          String    @unique
+  email          String        @unique
   hashedPassword String?
   sessions       Session[]
   roles          Role[]
+  posts          Post[]
+  postLikes      LikePost[]
+  postComments   PostComment[]
 }
 model Session {
   id                 Int       @default(autoincrement()) @id
@@ -37,13 +53,8 @@
   publicData         String?
   privateData        String?
 }
-enum UserRole {
-  ADMIN
-  USER
-}
-
 model Role {
   id    Int      @default(autoincrement()) @id
   name  UserRole @unique
   users User[]
@@ -54,4 +65,45 @@
   createdAt DateTime @default(now())
   updatedAt DateTime @updatedAt
   name      String
 }
+
+model Post {
+  id        Int           @default(autoincrement()) @id
+  createdAt DateTime      @default(now())
+  updatedAt DateTime      @updatedAt
+  slug      String        @default(cuid()) @unique
+  title     String
+  content   String
+  status    PostStatus    @default(POST_STATUS_DRAFT)
+  author    User          @relation(fields: [authorId], references: [id])
+  authorId  Int
+  likes     LikePost[]
+  comments  PostComment[]
+
+  @@index([status])
+}
+
+model LikePost {
+  id        Int      @default(autoincrement()) @id
+  createdAt DateTime @default(now())
+  post      Post     @relation(fields: [postId], references: [id])
+  postId    Int
+  user      User     @relation(fields: [userId], references: [id])
+  userId    Int
+
+  @@unique([postId, userId])
+}
+
+model PostComment {
+  id        Int           @default(autoincrement()) @id
+  createdAt DateTime      @default(now())
+  updatedAt DateTime      @updatedAt
+  content   String
+  post      Post          @relation(fields: [postId], references: [id])
+  postId    Int
+  user      User          @relation(fields: [userId], references: [id])
+  userId    Int
+  parentId  Int?
+  parent    PostComment?  @relation("CommentChildren", fields: [parentId], references: [id])
+  comments  PostComment[] @relation("CommentChildren")
+}
```


